name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: go-gui/go.sum

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev

    - name: Download Go modules
      working-directory: ./go-gui
      run: go mod download

    - name: Run tests
      working-directory: ./go-gui
      run: go test -v -race -coverprofile=coverage.out ./...

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        files: ./go-gui/coverage.out
        fail_ci_if_error: false
      continue-on-error: true

  build:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: go-gui/go.sum

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev

    - name: Build Linux
      working-directory: ./go-gui
      run: go build -o ../ps3syscon-linux .

    - name: Verify build
      run: test -f ps3syscon-linux && echo "Build successful"

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: go-gui/go.sum

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev

    - name: Run go vet
      working-directory: ./go-gui
      run: go vet ./...

    - name: Check formatting
      working-directory: ./go-gui
      run: |
        gofmt -s -w .
        if [ -n "$(gofmt -l .)" ]; then
          echo "Files not formatted:"
          gofmt -l .
          exit 1
        fi
